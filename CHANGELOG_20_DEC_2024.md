# Отчёт по изменениям на бэкенде — 20 декабря 2024

## Раздел 1: Исправления за сегодня

### Задача #3: Запрет отмены оплаченной поездки

**Проблема:**  
Арендатор мог отменить уже оплаченную поездку напрямую, без участия поддержки.

**Решение:**  
1. При попытке отменить оплаченную поездку через `cancel-by-client` — автоматически создаётся обращение в техподдержку с полной информацией о платеже
2. При попытке отменить через обычный PATCH-запрос — возвращается ошибка с просьбой обратиться в поддержку
3. Поездка остаётся в статусе `started`, решение принимает менеджер

**Файлы:**
- `chat/views.py` — логика создания обращения в `cancel_by_client`
- `chat/serializers.py` — блокировка отмены через PATCH

**Статус:** ✅ Задеплоено

---

### Задача #6: Отмена заявки арендодателем

**Проблема:**  
При отмене заявки (RequestRent → `denied`) арендодателем:
- Уведомление арендатору приходило ✅
- Но связанная поездка (Trip) оставалась со статусом `started` ❌
- Платёж (Payment) оставался активным ❌
- Арендатор мог оплатить уже отменённую заявку ❌

**Решение:**  
При установке статуса `denied` на RequestRent теперь автоматически:
1. Отменяется связанный Trip (`status = 'canceled'`)
2. Отменяется связанный Payment (`status = 'canceled'`)

**Файл:** `chat/views.py` (метод `perform_update` в `RequestRentViewSet`)

**Статус:** ✅ Задеплоено

---

### Задача #12: Комиссия на стоимость доставки

**Проблема:**  
1. При сохранении транспорта `price_delivery` накручивалась комиссия (1000 → 1200)
2. Стоимость доставки не добавлялась к платежу в Tinkoff

**Решение:**  
1. Убрана накрутка комиссии на `price_delivery` — доставка сохраняется как есть
2. В платёж Tinkoff добавлена доставка: `total_amount = commission + delivery`
3. В чеке Tinkoff две позиции: "Комиссия платформы" и "Доставка транспорта"

**Файлы:**
- `vehicle/models.py` — убрана накрутка в `Vehicle.save()`
- `payment/views.py` — добавлена доставка к платежу

**Итоговая логика:**
| Параметр | Значение |
|----------|----------|
| `price_delivery` в Vehicle | Сохраняется как есть (1000 → 1000) |
| `payment.amount` | Комиссия от аренды (без доставки) |
| `payment.delivery` | Стоимость доставки (без комиссии) |
| Сумма в Tinkoff | `amount + delivery` |

**Статус:** ✅ Задеплоено и проверено на сервере

---

## Раздел 2: Мультивалютность — анализ и предложение

### Текущая ситуация

- В базе есть **44 валюты** (RUB, USD, EUR, THB, AED и др.)
- У пользователя есть поле `currency` — валюта для отображения
- **У транспорта нет привязки к валюте** — все цены хранятся "как есть"
- **Tinkoff принимает оплату только в рублях**

### Проблема

Сервис работает в разных странах (Россия, Таиланд, ОАЭ и др.). Нужно:
1. Арендодатель создаёт транспорт в своей валюте (например, 1000 AED/день)
2. Цена фиксируется в этой валюте и не меняется при колебаниях курса
3. Арендатор видит цену в оригинальной валюте + может посмотреть в своей
4. При оплате сумма конвертируется в рубли для Tinkoff

### Предлагаемое решение

#### Логика работы

```
АРЕНДОДАТЕЛЬ (ОАЭ)          АРЕНДАТОР (США)           TINKOFF
      │                           │                      │
 Создаёт авто               Смотрит авто            Принимает
 1000 AED/день              в USD или AED           только RUB
      │                           │                      │
      ▼                           ▼                      ▼
┌─────────────────────────────────────────────────────────────┐
│                         BACKEND                              │
│                                                              │
│  1. Транспорт хранит цену в своей валюте (1000 AED)        │
│  2. При создании заявки — курс фиксируется                  │
│  3. Сумма конвертируется в RUB для оплаты                  │
│  4. Арендатор платит в рублях через Tinkoff                │
└─────────────────────────────────────────────────────────────┘
```

#### Пример сценария

1. **Арендодатель** создаёт авто: 1000 AED/день
2. **Арендатор** создаёт заявку на 3 дня
3. **Backend**:
   - Сохраняет: `total_cost = 3000 AED`
   - Получает текущий курс: 1 AED = 27.2 RUB
   - Рассчитывает: `total_cost_rub = 81 600 RUB`
   - Комиссия платформы: `81 600 × 20% = 16 320 RUB`
4. **Tinkoff** получает: 16 320 RUB

#### Что видит арендатор

```
Стоимость аренды: 3 000 AED
                  ≈ $817 (по текущему курсу)

К оплате (комиссия платформы): 16 320 ₽
```

### Уточняющие вопросы

1. **Валюта по умолчанию для существующих транспортов** — считать все текущие цены рублями?

2. **Выбор валюты при создании транспорта** — арендодатель выбирает вручную или определяется автоматически по городу/стране?

3. **Отображение цен для арендатора** — показывать:
   - Только оригинальную валюту транспорта?
   - Оригинал + конвертация в валюту пользователя?
   - Переключатель между валютами?

4. **Депозит** — тоже конвертировать в рубли или оставить информационным (не проходит через Tinkoff)?

5. **Частота обновления курсов** — раз в час достаточно? Или нужно чаще/реже?

6. **Источник курсов** — использовать бесплатный API (exchangerate-api.com) или нужен конкретный источник (ЦБ РФ, банк)?

---

## Следующие шаги

После получения ответов на вопросы:
1. Добавить поле `currency` в модель Vehicle
2. Добавить поля для фиксации курса в RequestRent
3. Реализовать сервис обновления курсов
4. Обновить API для отображения цен в разных валютах
5. Доработать Flutter для отображения мультивалютности
