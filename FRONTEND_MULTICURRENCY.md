# Мультивалютность — Инструкция для фронтенда

## Обзор изменений

Бэкенд теперь поддерживает мультивалютность:
- Каждый транспорт имеет свою валюту (определяется по городу или вручную)
- Цены отображаются в валюте транспорта
- Возможна конвертация в валюту пользователя
- Оплата через Tinkoff всегда в рублях

---

## Новые поля в API

### 1. Currency (валюта)

**GET /api/currency/**

Возвращает список всех валют с новыми полями:

```json
{
  "id": 1,
  "code": "RUB",
  "title": "Российский рубль",
  "symbol": "₽",
  "rate_to_rub": "1.000000"
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `symbol` | string | Символ валюты (₽, $, €, ฿ и т.д.) |
| `rate_to_rub` | decimal | Курс к рублю (сколько рублей за 1 единицу) |

---

### 2. Vehicle (транспорт)

В ответах списка и детальной информации о транспорте добавлены поля:

```json
{
  "id": 123,
  "brand": {...},
  "model": {...},
  "currency": {
    "id": 2,
    "code": "THB",
    "symbol": "฿",
    "title": "Тайский бат"
  },
  "user_currency": {
    "id": 1,
    "code": "RUB",
    "symbol": "₽",
    "title": "Российский рубль"
  },
  "rent_prices": [
    {
      "name": "1 день",
      "price": "1000.00",
      "discount": 0,
      "total": "1000.00",
      "price_converted": "2850.00",
      "total_converted": "2850.00"
    }
  ]
}
```

| Поле | Описание |
|------|----------|
| `currency` | Валюта транспорта (в которой указаны цены) |
| `user_currency` | Валюта пользователя (для конвертации) |
| `rent_prices[].price_converted` | Цена в валюте пользователя (null если совпадает) |
| `rent_prices[].total_converted` | Итого в валюте пользователя (null если совпадает) |

---

### 3. Принудительная конвертация

Можно указать валюту для конвертации через query параметр:

```
GET /api/vehicles/auto/?currency=USD
```

Тогда `user_currency` и `*_converted` поля будут в указанной валюте.

---

### 4. API конвертации

**GET /api/currency/convert/**

Конвертация суммы между валютами:

```
GET /api/currency/convert/?amount=1000&from=THB&to=RUB
```

Ответ:
```json
{
  "amount": 1000,
  "from": "THB",
  "to": "RUB",
  "result": "2850.00",
  "rate": "2.85"
}
```

---

### 5. City (город)

Города теперь имеют привязку к валюте:

```json
{
  "id": 1,
  "title": "Пхукет",
  "country": "Таиланд",
  "currency": {
    "id": 2,
    "code": "THB",
    "symbol": "฿"
  }
}
```

---

## Логика отображения цен

### Правила:

1. **По умолчанию** — показывать цену в валюте транспорта (`currency`)
2. **Если пользователь изменил валюту в настройках** — показывать конвертированную цену
3. **На странице оплаты** — всегда показывать сумму в рублях (Tinkoff)

### Пример отображения:

```
Цена: ฿1,000/день
(≈ ₽2,850)
```

Или если пользователь выбрал USD:
```
Цена: $28.50/день
(฿1,000 в оригинале)
```

---

## Создание/редактирование транспорта

### Авто-определение валюты

При создании транспорта валюта определяется автоматически по городу.
Если город имеет привязку к валюте — она будет установлена.

### Ручной выбор

Арендодатель может изменить валюту вручную:

```json
POST /api/vehicles/auto/
{
  "city": 5,
  "currency_id": 2,  // опционально, если нужно переопределить
  ...
}
```

---

## Оплата

### Конвертация в рубли

При создании платежа сумма автоматически конвертируется в рубли:

```
Транспорт: ฿1,000/день × 3 дня = ฿3,000
Конвертация: ฿3,000 × 2.85 = ₽8,550
Tinkoff получает: 8550 копеек = 85.50 рублей
```

### Депозит

- Если оплачивается онлайн — конвертируется в рубли
- Если наличными — показывается в валюте транспорта

---

## Настройки пользователя

Пользователь может выбрать предпочитаемую валюту в профиле:

```json
PATCH /api/users/{id}/
{
  "currency": 3  // ID валюты
}
```

После этого все цены будут показываться с конвертацией в эту валюту.

---

## Обновление курсов

Курсы обновляются автоматически каждый час через Celery.

Для ручного обновления (только админы):
```
POST /api/currency/update-rates/
```

---

## Миграция существующих данных

После деплоя нужно:

1. Применить миграции:
```bash
python manage.py migrate
```

2. Обновить курсы валют:
```bash
python manage.py shell
>>> from app.services.currency_service import CurrencyService
>>> CurrencyService.update_rates()
```

3. Настроить валюты для городов в админке

4. Существующие транспорты получат валюту при следующем сохранении (или можно обновить массово через shell)

---

## Чеклист для фронтенда

- [ ] Обновить модель Currency (добавить symbol, rate_to_rub)
- [ ] Обновить модель Vehicle (добавить currency, user_currency)
- [ ] Отображать символ валюты рядом с ценой
- [ ] Показывать конвертированную цену если user_currency != currency
- [ ] Добавить выбор валюты в настройках пользователя
- [ ] На странице оплаты показывать сумму в рублях
- [ ] При создании транспорта — показывать авто-определённую валюту
- [ ] Добавить возможность изменить валюту транспорта вручную
