# Сводка изменений на бэкенде за последние 2 недели

## 17 декабря 2025

- **Trip создаётся только после оплаты** — убрано создание Trip при accept, теперь Trip создаётся только после успешной оплаты
- **Сортировка транспорта** — добавлены поля `id` и `verified` в `ordering_fields` для всех ViewSet
- **Статус `paid` для RequestRent** — добавлен новый статус, который устанавливается после успешной оплаты
- **Исправлена ошибка 500** при подтверждении заявок "по запросу" (on_request) — пропуск вычитания дат из availabilities с null датами

## 16 декабря 2025

- **Исправлена логика `on_request`** — теперь корректно определяется, попадают ли даты в обычные availability периоды

## 12 декабря 2025

- **Проверка influencer** при создании реферальной ссылки — добавлена проверка существования объекта influencer

## 10 декабря 2025

- **Статус RequestRent → accept** после успешной оплаты
- **chat_id возвращается** для всех заявок, не только on_request
- **Автоотклонение конфликтующих заявок** при подтверждении одной
- **Trip со статусом started** создаётся сразу для обычных заявок
- **Сортировка журнала** по id desc (новые первыми)
- **Вычитание дат из availabilities** после оплаты для обычных поездок
- **payment_id возвращается** сразу для обычных заявок
- **Добавлены поля** в AutoListSerializer
- **Обработка None** для city и lessor в сериализаторах

## 9 декабря 2025

- **Разделение логики** для обычных и on_request заявок
- **Payment создаётся сразу** для обычных заявок, для on_request — после подтверждения
- **Загрузка фото через FormData** в PATCH запросах
- **Счётчики неверифицированных** в AllVehiclesListView для админов
- **Сортировка неверифицированных первыми** для админов/менеджеров
- **Фильтр по роли** в UserViewSet
- **Push-уведомления через FCM** — поддержка мобильных устройств, device_type, silent mode
- **Исправлены URL уведомлений** — теперь ведут на фронтенд
- **Исправлен расчёт rental_days** — округление вверх при превышении 24ч

---

**Всего коммитов:** 35
